flowchart TD
    subgraph "User Space"
        App["Application (DNS Client)"]
        Lib["Socket Libraries"]
        TC_Tool["TC Command Tool"]
        Loader["loader.c Program"]
        LibBPF["libbpf"]
    end
    
    subgraph "Kernel Space"
        subgraph "Network Stack"
            Socket["Socket Layer"]
            Transport["Transport Layer (UDP)"]
            Network["Network Layer (IPv6)"]
            Link["Link Layer"]
            Driver["Device Drivers"]
        end
        
        subgraph "eBPF Subsystem"
            Verifier["BPF Verifier"]
            JIT["JIT Compiler"]
            Maps["BPF Maps"]
            Program["BPF Program (add_pdm_header)"]
        end
        
        subgraph "Traffic Control"
            Qdisc["Queueing Discipline (clsact)"]
            Filter["TC Filter (classifier)"]
            Action["TC Action"]
        end
    end
    
    Hardware["Network Hardware"]
    
    %% User space interactions
    App <--> Lib
    Loader --> LibBPF
    Loader --> TC_Tool
    
    %% Loading process
    LibBPF --> Verifier
    Verifier --> JIT
    JIT --> Program
    TC_Tool --> Qdisc
    TC_Tool --> Filter
    
    %% Network stack flow
    App <--> Socket
    Socket <--> Transport
    Transport <--> Network
    Network <--> Link
    Link <--> Driver
    Driver <--> Hardware
    
    %% eBPF hooks
    Filter --> Program
    Network -- "Egress Path" --> Qdisc
    Qdisc --> Filter
    Program -- "Modify Packet" --> Action
    Action --> Link
    
    %% Data sharing
    Program <--> Maps
    
    %% Load and attach flow
    Loader -. "1. Load BPF Object" .-> Program
    Loader -. "2. Setup TC qdisc" .-> Qdisc
    Loader -. "3. Attach Program" .-> Filter
    
    %% Packet flow annotations
    Socket -. "1. Application sends DNS query" .-> Transport
    Transport -. "2. UDP encapsulation" .-> Network
    Network -. "3. IPv6 encapsulation" .-> Qdisc
    Qdisc -. "4. Pass to classifier" .-> Filter
    Filter -. "5. Invoke BPF program" .-> Program
    Program -. "6. Insert PDM header" .-> Action
    Action -. "7. Forward modified packet" .-> Link
    Link -. "8. Send to network" .-> Driver
